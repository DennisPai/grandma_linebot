# 系統測試計畫

## 測試環境

- **本地測試**: 使用 ngrok 測試 Line Webhook
- **Staging**: Zeabur 測試環境
- **Production**: Zeabur 生產環境

## 單元測試（計畫實作）

目前專案重點在功能實作，單元測試可後續補充。

建議測試範圍：
- Prompt Builder
- RAG 檢索邏輯
- 文字渲染引擎
- 用戶畫像提取

## 整合測試

### 1. Line Bot 對話測試

**測試場景**：

✅ **基本對話**
- [ ] 用戶發送簡單問候
- [ ] Bot 使用阿東人設回覆
- [ ] 對話記憶功能正常
- [ ] 回覆時間在 25 秒內

✅ **上下文記憶**
- [ ] 用戶提及個人資訊（如「我女兒在國外」）
- [ ] Bot 記住資訊
- [ ] 下次對話不重複詢問
- [ ] 用戶畫像正確更新

✅ **30 秒回覆機制**
- [ ] 快速回覆使用 Reply Token
- [ ] 慢速回覆使用 Push API
- [ ] 錯誤處理正確

### 2. 早安訊息測試

**測試場景**：

✅ **自動生成**
- [ ] n8n 工作流程按時觸發
- [ ] 為每個用戶生成個性化內容
- [ ] 訊息進入待審核佇列
- [ ] 圖片生成正常（如需要）

✅ **審核流程**
- [ ] 後台可以查看待審核訊息
- [ ] 可以編輯訊息內容
- [ ] 可以批准/拒絕訊息
- [ ] 批准後自動發送

✅ **時間隨機化**
- [ ] 每日發送時間不同
- [ ] 時間在設定窗口內（如 07:00-08:30）
- [ ] 下次發送時間正確更新

### 3. 圖片生成測試

**測試場景**：

✅ **寫實照片**
- [ ] 生成符合手機拍攝風格
- [ ] 第一人稱視角正確
- [ ] 自拍時有戴口罩
- [ ] 上傳到 Google Drive 成功
- [ ] Line 中可以正常顯示

✅ **長輩圖（三階段）**
- [ ] 階段 1：底圖生成，無文字
- [ ] 階段 2：AI 視覺分析返回有效 JSON
- [ ] 階段 3：Canvas 成功渲染中文
- [ ] 文字清晰，描邊效果好
- [ ] 整體風格符合長輩圖特色
- [ ] 上傳到 Google Drive 成功

### 4. RAG 知識庫測試

**測試場景**：

✅ **文檔上傳**
- [ ] 上傳 TXT 文件
- [ ] 自動向量化
- [ ] 儲存到 ChromaDB
- [ ] 標記為已索引

✅ **知識檢索**
- [ ] 相關文檔能被檢索到
- [ ] 檢索結果相關性高
- [ ] 根據用戶興趣重排
- [ ] 引用次數正確更新

✅ **AI 對話整合**
- [ ] 對話中自然融入知識內容
- [ ] 不會生硬引用
- [ ] 符合阿東人設

### 5. 後台管理系統測試

**測試場景**：

✅ **認證**
- [ ] Google OAuth 登入成功
- [ ] Line Login 成功（如已實作）
- [ ] 未登入時重定向到登入頁

✅ **儀表板**
- [ ] 統計數據正確顯示
- [ ] 即時更新（如已實作 WebSocket）

✅ **對話監控**
- [ ] 可以查看所有對話
- [ ] 篩選功能正常
- [ ] 對話詳情完整

✅ **訊息審核**
- [ ] 待審核列表正確
- [ ] 編輯功能正常
- [ ] 批准/拒絕功能正常

✅ **用戶管理**
- [ ] 用戶列表完整
- [ ] 用戶畫像正確顯示
- [ ] 統計數據準確

✅ **文檔管理**
- [ ] 上傳功能正常
- [ ] 分類和標籤功能
- [ ] 檢索測試正常

### 6. AI 管家測試（Phase 6）

**測試場景**：

✅ **基本對話**
- [ ] 可以詢問用戶狀態
- [ ] 可以要求分析趨勢
- [ ] 可以生成報告
- [ ] 回覆準確且有用

✅ **模型切換**
- [ ] 可以選擇不同模型
- [ ] 顯示當前使用模型
- [ ] 成本追蹤正確

---

## 效能測試

### 回應時間測試

**目標**：
- Webhook 回覆：< 25 秒（95% 情況）
- API 查詢：< 1 秒
- 圖片生成：< 30 秒

**測試方法**：
```bash
# 使用 Apache Bench 測試
ab -n 100 -c 10 https://linebot-api.zeabur.app/health
```

### 並發測試

模擬多用戶同時傳送訊息：

```bash
# 測試 10 個並發請求
for i in {1..10}; do
  curl -X POST https://linebot-api.zeabur.app/api/test &
done
```

### 資料庫負載測試

監控在高負載下的資料庫效能：
- 連接池是否足夠
- 查詢是否有 N+1 問題
- 索引是否有效

---

## 安全測試

### 1. Webhook 驗證測試

嘗試發送未簽名的請求，應該被拒絕：

```bash
curl -X POST https://linebot-api.zeabur.app/webhook/line \
  -H "Content-Type: application/json" \
  -d '{"events": []}'
```

預期結果：`401 Unauthorized` 或 `403 Forbidden`

### 2. OAuth 測試

- [ ] 嘗試訪問需要認證的頁面，應重定向到登入
- [ ] Callback URL 驗證正確
- [ ] Token 過期後要求重新登入

### 3. 環境變數洩漏測試

- [ ] API 錯誤不洩漏敏感資訊
- [ ] 日誌中沒有 API KEY
- [ ] 前端不暴露後端配置

---

## 自動化測試（CI/CD）

GitHub Actions 會在每次 push 時執行：

1. ✅ 安裝依賴
2. ✅ 執行測試（`pnpm test`）
3. ✅ 建置專案（`pnpm build`）
4. ✅ 部署到 Zeabur（僅 main 分支）

查看測試結果：
- GitHub Actions 分頁
- 綠色勾號 ✅ = 測試通過
- 紅色叉號 ❌ = 測試失敗

---

## 測試資料

### 測試用戶

建議建立幾個測試用戶帳號：
1. 測試基本對話
2. 測試早安訊息
3. 測試圖片生成
4. 測試長期對話記憶

### 測試文檔

準備一些測試文檔：
- 健康養生類
- 金融投資類
- 家庭關係類

### 測試圖片

測試長輩圖生成的不同場景：
- 早安問候
- 勵志語錄
- 健康提醒
- 祝福訊息

---

## 上線前最終檢查

- [ ] 所有功能測試通過
- [ ] 效能符合要求
- [ ] 安全性檢查通過
- [ ] 文檔完整
- [ ] 環境變數正確
- [ ] 備份機制啟用
- [ ] 監控與告警設定
- [ ] 團隊成員已培訓

**確認無誤後，即可正式上線！** 🚀
