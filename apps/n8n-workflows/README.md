# n8n 工作流程

本資料夾包含所有 n8n 自動化工作流程的定義和部署腳本。

## 工作流程列表

### 1. 早安訊息排程 (`morning-greeting.json`)

- **觸發時間**：每天 06:00-09:00，每 5 分鐘檢查一次
- **功能**：
  1. 檢查哪些用戶需要發送早安訊息
  2. 為每個用戶生成個性化早安內容
  3. 建立待審核訊息（供管理員審核後發送）

### 2. 用戶畫像定期分析 (`user-profiling.json`)

- **觸發時間**：每天凌晨 02:00
- **功能**：
  1. 取得所有活躍用戶
  2. 分析每個用戶的對話記錄
  3. 更新用戶畫像資訊

### 3. 對話品質分析 (`conversation-analysis.json`)

- **觸發時間**：每天凌晨 03:00
- **功能**：
  1. 分析對話品質
  2. 生成統計報告
  3. 識別需要改進的部分

## 部署方式

### 自動部署（推薦）

在 Zeabur Console 中執行：

```bash
pnpm --filter n8n-workflows deploy
```

或在本地執行：

```bash
cd apps/n8n-workflows
pnpm deploy
```

### 環境變數需求

確保以下環境變數已設定：

- `N8N_API_URL`: n8n API 端點（例如：https://your-n8n-domain.zeabur.app/api/v1）
- `N8N_API_KEY`: n8n API 金鑰（從後台系統配置載入）
- `LINEBOT_API_URL`: Line Bot API 端點（用於 n8n 回調）

**注意**：這些環境變數將從後台系統配置自動載入，無需手動在 `.env` 檔案中設定。

## 工作流程管理

部署腳本會：
- 自動檢查工作流程是否已存在
- 如果存在，更新工作流程
- 如果不存在，建立新工作流程
- 保持工作流程啟用狀態

## 監控

可以在 n8n 管理介面中查看：
- 工作流程執行歷史
- 錯誤日誌
- 執行統計

## 故障排除

如果部署失敗：

1. 檢查 N8N_API_KEY 是否正確
2. 確認 N8N_API_URL 可以訪問
3. 檢查 JSON 格式是否正確
4. 查看錯誤訊息中的詳細資訊
